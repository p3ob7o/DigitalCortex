# T05.5: Morning Brief ‚Äî Linear Integration ‚Äî Tests

## Test Environment

```
test-vault-populated/          ‚Üê With project files having linear_project mapping
```

**Mocks:**
- Linear GraphQL API responses
- No network calls

---

## Test Suite: Issue Retrieval

### T05.5.1: Fetch assigned issues from all teams
**Code type:** Python script

```pseudo
GIVEN user assigned to issues in Domain team and Jetpack team
WHEN fetch_linear_issues()
THEN returns issues from both teams
AND each issue has team info attached
```

### T05.5.2: Exclude completed and canceled issues
**Code type:** Python script

```pseudo
GIVEN mock returns issues with states:
  - "In Progress" (started)
  - "Done" (completed)
  - "Cancelled" (canceled)
  - "Backlog" (backlog)
WHEN fetch_linear_issues(active_only=true)
THEN excludes "Done" and "Cancelled"
AND includes "In Progress" and "Backlog"
```

### T05.5.3: Fetch issues completed since last brief
**Code type:** Python script

```pseudo
GIVEN last_brief = 2025-01-30T08:00:00Z
AND 2 issues completed after this timestamp
WHEN fetch_linear_completed(since=last_brief)
THEN returns 2 completed issues
```

### T05.5.4: Include issue priority
**Code type:** Python script

```pseudo
GIVEN issue with priority: 1 (Urgent)
WHEN fetch_linear_issues() returns issue
THEN issue.priority = 1
AND issue.priority_label = "Urgent"
```

### T05.5.5: Include due date
**Code type:** Python script

```pseudo
GIVEN issue with dueDate: "2025-01-31"
WHEN fetch_linear_issues() returns issue
THEN issue.due_date = "2025-01-31"
```

---

## Test Suite: Categorization

### T05.5.6: Identify overdue issues
**Code type:** Python script

```pseudo
GIVEN issue with due_date = 2025-01-30
AND today = 2025-01-31
WHEN categorize_issue(issue)
THEN category = "overdue"
AND flag = "‚ö†"
```

### T05.5.7: Identify issues due today
**Code type:** Python script

```pseudo
GIVEN issue with due_date = 2025-01-31
AND today = 2025-01-31
WHEN categorize_issue(issue)
THEN category = "due_today"
```

### T05.5.8: Identify issues due this week
**Code type:** Python script

```pseudo
GIVEN issue with due_date within next 7 days
WHEN categorize_issue(issue)
THEN category = "due_this_week"
```

### T05.5.9: Identify blocked issues
**Code type:** Python script

```pseudo
GIVEN issue with state.name containing "blocked"
WHEN categorize_issue(issue)
THEN category = "blocked"
AND flag = "‚ö† BLOCKED"
```

### T05.5.10: Priority mapping
**Code type:** Python script

```pseudo
FOR EACH (priority_value, expected_label, expected_indicator) in:
  (0, "No priority", "‚Äî")
  (1, "Urgent", "üî¥")
  (2, "High", "üü†")
  (3, "Normal", "‚Äî")
  (4, "Low", "üîµ")
GIVEN issue with priority = $priority_value
WHEN map_priority(issue)
THEN label = $expected_label
AND indicator = $expected_indicator
```

---

## Test Suite: Project Linking

### T05.5.11: Match Linear project to Obsidian project
**Code type:** Python script

```pseudo
GIVEN Linear issue in project "Domain Bundling" (id: proj-abc)
AND 3_Projects/domain-bundling/domain-bundling.md has:
  linear_project: proj-abc
WHEN process_issue(issue)
THEN project_link = "[[domain-bundling]]"
```

### T05.5.12: No link for unmatched project
**Code type:** Python script

```pseudo
GIVEN Linear issue in project with no Obsidian mapping
WHEN process_issue(issue)
THEN project_link = null
AND Linear project name shown as text
```

### T05.5.13: Match Linear label to Obsidian area
**Code type:** Python script

```pseudo
GIVEN Linear issue with label "Domaison"
AND 4_Areas/domaison.md has:
  linear_label: Domaison
WHEN process_issue(issue)
THEN area_link = "[[domaison]]"
```

---

## Test Suite: Output Formatting

### T05.5.14: Format completed issues as wins
**Code type:** Python script

```pseudo
GIVEN 2 completed issues since last brief
WHEN format_completed_section(issues)
THEN output:
  "### Completed Since Yesterday
   - [x] Review mockups (DOMAIN-123)
   - [x] Send weekly report (TOTORO-12)
   
   üéâ 2 tasks completed!"
```

### T05.5.15: Format due today section
**Code type:** Python script

```pseudo
GIVEN issue due today with high priority
WHEN format_due_today(issues)
THEN output:
  "**Due Today**
   - [ ] üü† Send revised pricing (DOMAIN-456) ‚Äî [[domain-bundling]]"
```

### T05.5.16: Format blocked issues with reason
**Code type:** Python script

```pseudo
GIVEN blocked issue with blocker description
WHEN format_blocked(issues)
THEN output includes:
  "- [ ] Fix billing edge case (DOMAIN-111) ‚Äî **BLOCKED**
   Blocker: Waiting on Legal approval"
```

### T05.5.17: Group by team
**Code type:** Python script

```pseudo
GIVEN config.linear.group_by = "team"
AND issues from Domain and Jetpack teams
WHEN format_issues_section(issues)
THEN output grouped:
  "**Domain Team** (3 issues)
   - DOMAIN-456: ...
   - DOMAIN-789: ...
   
   **Jetpack Team** (1 issue)
   - JETPACK-222: ..."
```

### T05.5.18: Include issue identifier
**Code type:** Python script

```pseudo
GIVEN issue with identifier: "DOMAIN-456"
WHEN format_issue(issue)
THEN output includes identifier in parentheses or prefix
```

---

## Test Suite: Write Capabilities

### T05.5.19: Create issue in personal team only
**Code type:** Python script

```pseudo
GIVEN config.linear.personal_team = "Totoro"
WHEN create_issue(team="Totoro", title="Test task")
THEN issue created successfully

WHEN create_issue(team="Domain", title="Test task")
THEN raises PermissionError: "Can only create in personal team"
```

### T05.5.20: Update issue status
**Code type:** Python script

```pseudo
GIVEN issue TOTORO-123 in personal team
WHEN update_issue(id="TOTORO-123", state="Done")
THEN issue state updated

GIVEN issue DOMAIN-456 in other team
WHEN update_issue(id="DOMAIN-456", state="Done")
THEN raises PermissionError
```

### T05.5.21: Create issue from email action
**Code type:** Prompt/Response

```pseudo
GIVEN email with detected action: "Review contract by EOD"
AND user confirms task creation
WHEN creating task
THEN Claude calls create_issue with:
  - team: "Totoro"
  - title: "Review contract"
  - due_date: today
```

---

## Test Suite: Error Handling

### T05.5.22: Handle auth expired
**Code type:** Python script

```pseudo
GIVEN mock Linear API returns 401 Unauthorized
WHEN fetch_linear_issues()
THEN raises AuthExpiredError
AND message includes re-auth instructions
```

### T05.5.23: Handle API timeout
**Code type:** Python script

```pseudo
GIVEN mock Linear API times out
WHEN fetch_linear_issues()
THEN retries once
AND if still fails, uses cached data if fresh (<4h)
```

### T05.5.24: Handle rate limiting
**Code type:** Python script

```pseudo
GIVEN mock Linear API returns 429 Too Many Requests
WHEN fetch_linear_issues()
THEN uses cached data if available
OR reports rate limit with backoff suggestion
```

### T05.5.25: Handle no assigned issues
**Code type:** Python script

```pseudo
GIVEN mock Linear API returns 0 assigned issues
WHEN fetch_linear_issues()
THEN returns empty list
AND brief shows: "No tasks assigned üéâ"
```

---

## Test Suite: Interactive Actions

### T05.5.26: Offer to update due date
**Code type:** Prompt/Response

```pseudo
GIVEN issue due today presented in brief
WHEN interactive review reaches issue
THEN Claude asks:
  "Is this still on track?
   [y] Yes
   [m] Move to tomorrow
   [b] Mark as blocked"
```

### T05.5.27: Mark issue as complete from brief
**Code type:** Prompt/Response

```pseudo
GIVEN open issue presented
AND user says "actually I finished this"
WHEN processing response
THEN Claude offers to mark as complete in Linear
```

---

## Mock Fixtures

### Linear API mock responses
```python
MOCK_LINEAR_ACTIVE = [
    {
        "id": "issue-123",
        "identifier": "DOMAIN-456",
        "title": "Update pricing documentation",
        "description": "Revise pricing page with new tiers",
        "state": {"name": "In Progress", "type": "started"},
        "priority": 2,
        "dueDate": "2025-02-14",
        "project": {"id": "proj-abc", "name": "Domain Bundling"},
        "team": {"id": "team-domain", "name": "Domain", "key": "DOMAIN"},
        "labels": {"nodes": [{"name": "Domaison"}]},
        "createdAt": "2025-01-20T10:00:00Z",
        "updatedAt": "2025-01-30T16:00:00Z"
    },
    {
        "id": "issue-456",
        "identifier": "DOMAIN-111",
        "title": "Fix billing edge case",
        "state": {"name": "Blocked", "type": "started"},
        "priority": 1,
        "dueDate": "2025-01-31",
        "team": {"id": "team-domain", "name": "Domain", "key": "DOMAIN"},
        "blockedByReason": "Waiting on Legal approval"
    }
]

MOCK_LINEAR_COMPLETED = [
    {
        "id": "issue-100",
        "identifier": "DOMAIN-123",
        "title": "Review mockups",
        "completedAt": "2025-01-30T16:00:00Z",
        "project": {"name": "BI Phase 1"},
        "team": {"name": "Domain"}
    }
]
```

### Project mapping fixture
```yaml
# 3_Projects/domain-bundling/domain-bundling.md
---
type: project
status: active
linear_project: proj-abc
---
```
