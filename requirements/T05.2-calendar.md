# T05.2: Morning Brief ‚Äî Calendar Integration ‚Äî Tests

## Test Environment

```
test-vault-populated/          ‚Üê With People files for attendee matching
```

**Mocks:**
- Google Calendar API responses
- System clock: 2025-01-31T08:00:00+01:00
- Timezone: Europe/Vienna (+01:00)

---

## Test Suite: Event Retrieval

### T05.2.1: Fetch today's events
**Code type:** Python script

```pseudo
GIVEN mock Calendar API returns 3 events for 2025-01-31
WHEN fetch_calendar(date="2025-01-31") is executed
THEN returns exactly 3 events
AND all events have start time on 2025-01-31
```

### T05.2.2: Events sorted by start time
**Code type:** Python script

```pseudo
GIVEN events at 14:00, 10:00, 16:00 (unsorted in response)
WHEN fetch_calendar() returns events
THEN events sorted: 10:00, 14:00, 16:00
```

### T05.2.3: Include all-day events
**Code type:** Python script

```pseudo
GIVEN all-day event: "Company Holiday"
AND timed event: "Standup at 10:00"
WHEN fetch_calendar()
THEN both events returned
AND all-day event marked with allDay: true
```

### T05.2.4: Expand recurring events
**Code type:** Python script

```pseudo
GIVEN recurring event: "Weekly Standup" every Friday
WHEN fetch_calendar(date="2025-01-31") (a Friday)
THEN single instance returned for this Friday
AND event shows actual date, not recurrence rule
```

### T05.2.5: Respect timezone
**Code type:** Python script

```pseudo
GIVEN event at 10:00 Europe/Vienna
AND user timezone is Europe/Vienna
WHEN fetch_calendar()
THEN event.start shows "10:00" (local time)
NOT UTC time
```

---

## Test Suite: Open Block Calculation

### T05.2.6: Calculate open blocks between meetings
**Code type:** Python script

```pseudo
GIVEN meetings:
  - 10:00-10:30
  - 14:00-15:00
AND working hours: 08:00-18:00
WHEN calculate_open_blocks(events)
THEN returns:
  - 08:00-10:00 (2h)
  - 10:30-14:00 (3.5h)
  - 15:00-18:00 (3h)
```

### T05.2.7: Apply buffer before meetings
**Code type:** Python script

```pseudo
GIVEN meeting at 10:00
AND config.buffer_minutes = 15
WHEN calculate_open_blocks(events)
THEN block before meeting ends at 09:45, not 10:00
```

### T05.2.8: Handle back-to-back meetings
**Code type:** Python script

```pseudo
GIVEN meetings:
  - 10:00-10:30
  - 10:30-11:00
WHEN calculate_open_blocks(events)
THEN no open block between these meetings
AND flag: "‚ö† Back-to-back meetings 10:00-11:00"
```

### T05.2.9: Handle overlapping events (conflict)
**Code type:** Python script

```pseudo
GIVEN events:
  - 10:00-11:00 Meeting A
  - 10:30-11:30 Meeting B
WHEN calculate_open_blocks(events)
THEN conflict detected
AND flag: "‚ö† Conflict: Meeting A and Meeting B overlap"
```

### T05.2.10: Handle all-day event in open blocks
**Code type:** Python script

```pseudo
GIVEN all-day event: "Focus Day"
WHEN calculate_open_blocks(events)
THEN all-day event does not block time slots
AND is noted separately
```

---

## Test Suite: Attendee Matching

### T05.2.11: Match attendee to People file
**Code type:** Python script

```pseudo
GIVEN event with attendee: jane@verisign.com
AND 8_People/jane-smith.md exists with email: jane@verisign.com
WHEN process_event(event)
THEN attendee linked: "[[jane-smith]]"
```

### T05.2.12: Include last contact for matched attendee
**Code type:** Python script

```pseudo
GIVEN event with attendee matching jane-smith.md
AND jane-smith.md has last_contact: 2025-01-28
WHEN process_event(event)
THEN attendee_context.last_contact = "2025-01-28"
```

### T05.2.13: Self-attendee excluded from matching
**Code type:** Python script

```pseudo
GIVEN event with attendees: [paolo@automattic.com, jane@verisign.com]
AND paolo@automattic.com is configured user email
WHEN process_event(event)
THEN only jane is in matched attendees
AND self not listed as external attendee
```

### T05.2.14: Multiple attendees all matched
**Code type:** Python script

```pseudo
GIVEN event with 3 external attendees
AND 2 have matching People files
WHEN process_event(event)
THEN 2 linked with [[person-name]]
AND 1 shown as email only
```

---

## Test Suite: Output Formatting

### T05.2.15: Format event for brief
**Code type:** Python script

```pseudo
GIVEN event:
  - summary: "1:1 with Jane Smith"
  - start: 14:00
  - end: 15:00
  - location: "Zoom"
  - conferenceData.uri: "https://zoom.us/j/123"
WHEN format_for_brief(event)
THEN output:
  "- **14:00‚Äì15:00** 1:1 with [[Jane Smith]]
   üìç Zoom ¬∑ [Join](https://zoom.us/j/123)"
```

### T05.2.16: Include conference link
**Code type:** Python script

```pseudo
GIVEN event with Zoom link in conferenceData
WHEN format_for_brief(event)
THEN output includes clickable "[Join](https://...)" link
```

### T05.2.17: Include last contact context
**Code type:** Python script

```pseudo
GIVEN event with matched attendee jane-smith
AND last_contact: 2025-01-28
WHEN format_for_brief(event)
THEN output includes:
  "üë§ Last contact: Jan 28 ‚Äî discussed bulk discount proposal"
```

### T05.2.18: Format all-day events separately
**Code type:** Python script

```pseudo
GIVEN all-day event: "Company Holiday"
AND timed events
WHEN format_calendar_section()
THEN output structure:
  "üìÖ **All day:** Company Holiday
   
   - **10:00-10:30** Standup..."
```

### T05.2.19: Show open blocks summary
**Code type:** Python script

```pseudo
GIVEN calculated open blocks
WHEN format_calendar_section()
THEN output includes:
  "**Open blocks:** 08:00‚Äì09:45, 10:30‚Äì13:45, 15:00‚Äì18:00"
```

---

## Test Suite: Event Write (Optional)

### T05.2.20: Create event on explicit request
**Code type:** Prompt/Response

```pseudo
GIVEN user says: "Block 2 hours tomorrow morning for deep work"
WHEN Claude processes request
THEN Claude confirms event details:
  "Creating: Deep Work Block
   Time: 2025-02-01 09:00‚Äì11:00
   Confirm? [y/n]"
AND waits for confirmation before creating
```

### T05.2.21: Do not auto-create events
**Code type:** Python script

```pseudo
GIVEN morning brief suggests time block
WHEN brief is generated
THEN calendar is NOT modified
AND suggestion is noted for user action only
```

---

## Test Suite: Error Handling

### T05.2.22: Handle auth expired
**Code type:** Python script

```pseudo
GIVEN mock Calendar API returns 401 Unauthorized
WHEN fetch_calendar()
THEN raises AuthExpiredError
AND message includes re-auth instructions
```

### T05.2.23: Handle no events
**Code type:** Python script

```pseudo
GIVEN mock Calendar API returns 0 events
WHEN fetch_calendar()
THEN returns empty list
AND brief shows: "No meetings today üéâ"
```

### T05.2.24: Handle calendar not found
**Code type:** Python script

```pseudo
GIVEN config references calendar ID that doesn't exist
WHEN fetch_calendar()
THEN error: "Calendar not found: <id>"
AND suggests checking config
```

---

## Test Suite: Weekly Review Extension

### T05.2.25: Fetch past week for weekly review
**Code type:** Python script

```pseudo
GIVEN request for weekly calendar data
WHEN fetch_calendar(range="past_week")
THEN returns events from Monday to Sunday of past week
```

### T05.2.26: Fetch next week for weekly preview
**Code type:** Python script

```pseudo
GIVEN request for weekly preview
WHEN fetch_calendar(range="next_week")
THEN returns events for upcoming 7 days
```

---

## Mock Fixtures

### Calendar API mock responses
```python
MOCK_CALENDAR_EVENTS = [
    {
        "id": "event-001",
        "summary": "Weekly Standup",
        "description": "Domain team sync",
        "start": {"dateTime": "2025-01-31T10:00:00+01:00", "timeZone": "Europe/Vienna"},
        "end": {"dateTime": "2025-01-31T10:30:00+01:00", "timeZone": "Europe/Vienna"},
        "location": "Zoom",
        "attendees": [
            {"email": "paolo@automattic.com", "self": True, "responseStatus": "accepted"},
            {"email": "colleague@automattic.com", "displayName": "Colleague", "responseStatus": "accepted"}
        ],
        "conferenceData": {
            "entryPoints": [{"entryPointType": "video", "uri": "https://zoom.us/j/123456"}]
        },
        "status": "confirmed"
    },
    {
        "id": "event-002",
        "summary": "1:1 with Jane Smith",
        "start": {"dateTime": "2025-01-31T14:00:00+01:00"},
        "end": {"dateTime": "2025-01-31T15:00:00+01:00"},
        "attendees": [
            {"email": "paolo@automattic.com", "self": True},
            {"email": "jane@verisign.com", "displayName": "Jane Smith"}
        ],
        "conferenceData": {
            "entryPoints": [{"entryPointType": "video", "uri": "https://zoom.us/j/789012"}]
        }
    },
    {
        "id": "event-003",
        "summary": "Company Holiday (US)",
        "start": {"date": "2025-01-31"},
        "end": {"date": "2025-02-01"},
        "allDay": True
    }
]
```
