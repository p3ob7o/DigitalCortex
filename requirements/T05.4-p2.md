# T05.4: Morning Brief ‚Äî P2 Integration ‚Äî Tests

## Test Environment

```
test-vault-populated/
```

**Mocks:**
- context-a8c MCP server responses (same server as Slack)
- No network calls

---

## Test Suite: Content Retrieval

### T05.4.1: Fetch posts mentioning user since last brief
**Code type:** Python script

```pseudo
GIVEN mock MCP returns 2 P2 posts with @paolo mention
AND last_brief = 2025-01-30T08:00:00Z
WHEN fetch_p2(since=last_brief)
THEN returns 2 mention items
AND all posted after last_brief timestamp
```

### T05.4.2: Fetch comments mentioning user
**Code type:** Python script

```pseudo
GIVEN mock MCP returns comment with @paolo mention
WHEN fetch_p2()
THEN returns comment item with:
  - type: comment
  - parent post reference
  - mention context
```

### T05.4.3: Fetch replies to user's posts
**Code type:** Python script

```pseudo
GIVEN user authored post "Q1 Pricing Analysis"
AND 3 new comments added since last brief
WHEN fetch_p2()
THEN returns activity item:
  - type: replies_to_my_post
  - post_title: "Q1 Pricing Analysis"
  - new_comment_count: 3
```

### T05.4.4: Include P2 site name
**Code type:** Python script

```pseudo
GIVEN mention from domain-team P2
WHEN fetch_p2() returns item
THEN item.p2_site = "domain-team"
```

---

## Test Suite: Categorization

### T05.4.5: Categorize direct mention (high priority)
**Code type:** Python script

```pseudo
GIVEN comment with @paolo direct mention
AND user has not replied
WHEN categorize_p2_item(comment)
THEN category = "direct_mention"
AND priority = "high"
AND response_needed = true
```

### T05.4.6: Categorize replies to user's post (high priority)
**Code type:** Python script

```pseudo
GIVEN new comment on user's post
AND comment asks a question
WHEN categorize_p2_item(activity)
THEN category = "reply_to_my_post"
AND priority = "high"
```

### T05.4.7: Categorize engagement activity (medium priority)
**Code type:** Python script

```pseudo
GIVEN user's post received 5 new comments (no questions)
WHEN categorize_p2_item(activity)
THEN category = "engagement"
AND priority = "medium"
```

### T05.4.8: Mark as replied-to
**Code type:** Python script

```pseudo
GIVEN mention where user already commented after
WHEN categorize_p2_item(mention)
THEN response_needed = false
```

---

## Test Suite: Output Formatting

### T05.4.9: Format P2 mention for brief
**Code type:** Python script

```pseudo
GIVEN mention:
  - p2_site: domain-team
  - post_title: "Weekly Standup Notes"
  - from: @manager
  - text: "Can you elaborate on bundling timeline?"
WHEN format_for_brief(mention)
THEN output:
  "- **Domain Team P2**: @manager asking about bundling timeline
   in 'Weekly Standup Notes'
   ‚Üí [View comment](https://domain-team.p2.automattic.com/...)"
```

### T05.4.10: Format post activity for brief
**Code type:** Python script

```pseudo
GIVEN user's post "Q1 Pricing Analysis" with:
  - 3 total comments
  - 2 new since last brief
  - Notable: @colleague asked about assumptions
WHEN format_for_brief(activity)
THEN output:
  "- **'Q1 Pricing Analysis'** received 2 new comments
   @colleague asks about assumptions
   ‚Üí [View post](https://domain-team.p2.automattic.com/...)"
```

### T05.4.11: Include post URL
**Code type:** Python script

```pseudo
GIVEN P2 item with URL
WHEN format_for_brief(item)
THEN output includes clickable link to post/comment
```

### T05.4.12: Combined Slack & P2 section
**Code type:** Python script

```pseudo
GIVEN 2 Slack items and 2 P2 items
WHEN format_combined_section()
THEN output under single "### Slack & P2" heading
AND P2 items labeled with P2 indicator
```

---

## Test Suite: Post Tracking

### T05.4.13: Track user's published posts
**Code type:** Python script

```pseudo
GIVEN user published post at 08:00
AND current time is 10:00
WHEN fetch_p2() includes engagement tracking
THEN returns post tracking data:
  - post_title
  - publish_time
  - current_comment_count
  - commenters list
```

### T05.4.14: Surface traction on recent posts
**Code type:** Python script

```pseudo
GIVEN user's post published 2 hours ago with 5 comments
WHEN generating brief
THEN output includes:
  "üìù Your post 'Q1 Pricing Analysis' is getting traction
   5 comments in first 2 hours"
```

---

## Test Suite: Error Handling

### T05.4.15: Handle MCP unavailable (same as Slack)
**Code type:** Python script

```pseudo
GIVEN mock MCP returns connection error
WHEN fetch_p2()
THEN raises MCPUnavailableError
AND since Slack uses same MCP, both fail together
```

### T05.4.16: Handle specific P2 site inaccessible
**Code type:** Python script

```pseudo
GIVEN MCP returns partial data (domain-team ok, but legal-team 403)
WHEN fetch_p2()
THEN returns domain-team data
AND warns: "Could not access: legal-team P2"
```

### T05.4.17: Handle empty results
**Code type:** Python script

```pseudo
GIVEN mock MCP returns 0 P2 items
WHEN fetch_p2()
THEN returns empty list
AND brief shows: "No P2 updates"
```

---

## Test Suite: Configuration

### T05.4.18: Respect site inclusion config
**Code type:** Python script

```pseudo
GIVEN config.p2.include_sites: ["domain-team", "jetpack-team"]
AND mention from excluded "random-p2"
WHEN fetch_p2()
THEN "random-p2" item not included
```

### T05.4.19: Respect site exclusion config
**Code type:** Python script

```pseudo
GIVEN config.p2.exclude_sites: ["firehose"]
AND mention from firehose P2
WHEN fetch_p2()
THEN firehose item not included
```

### T05.4.20: Toggle post tracking
**Code type:** Python script

```pseudo
GIVEN config.p2.track_my_posts: false
WHEN fetch_p2()
THEN user's post engagement data not fetched
AND no "traction" section in brief
```

---

## Mock Fixtures

### MCP mock responses for P2
```python
MOCK_P2_DATA = {
    "items": [
        {
            "type": "post",
            "p2_site": "domain-team",
            "title": "Q1 Transfer Pricing Analysis",
            "author": {"username": "paolo", "display_name": "Paolo"},
            "content": "Here's my analysis of the Q1 transfer pricing...",
            "url": "https://domain-team.p2.automattic.com/2025/01/31/q1-transfer-pricing",
            "date": "2025-01-31T08:00:00Z",
            "status": "publish",
            "comment_count": 3,
            "new_comments_since_last_brief": 2
        },
        {
            "type": "comment",
            "p2_site": "domain-team",
            "post_title": "Weekly Standup Notes",
            "post_url": "https://domain-team.p2.automattic.com/weekly-standup",
            "author": {"username": "manager", "display_name": "Manager Name"},
            "content": "@paolo can you elaborate on the bundling timeline?",
            "url": "https://domain-team.p2.automattic.com/weekly-standup#comment-123",
            "date": "2025-01-31T09:30:00Z",
            "is_mention": True,
            "is_reply_to_user": False
        },
        {
            "type": "comment",
            "p2_site": "domain-team",
            "post_title": "Q1 Transfer Pricing Analysis",
            "author": {"username": "colleague", "display_name": "Colleague Name"},
            "content": "Great analysis! One question about the assumptions...",
            "url": "https://domain-team.p2.automattic.com/q1-transfer-pricing#comment-456",
            "date": "2025-01-31T10:00:00Z",
            "is_mention": False,
            "is_reply_to_user": True
        }
    ]
}
```
