# T05.3: Morning Brief — Slack Integration — Tests

## Test Environment

```
test-vault-populated/          ← With People files
```

**Mocks:**
- context-a8c MCP server responses
- No network calls

---

## Test Suite: Message Retrieval

### T05.3.1: Fetch mentions since last brief
**Code type:** Python script

```pseudo
GIVEN mock MCP returns 3 mentions since last_brief timestamp
WHEN fetch_slack(since=last_brief) is executed
THEN returns 3 mention items
AND all have timestamp > last_brief
```

### T05.3.2: Fetch DMs since last brief
**Code type:** Python script

```pseudo
GIVEN mock MCP returns 2 DMs
WHEN fetch_slack()
THEN returns DMs as separate category
AND DMs have type: "dm"
```

### T05.3.3: Include surrounding context for mentions
**Code type:** Python script

```pseudo
GIVEN mention in thread with 5 messages
WHEN fetch_slack() retrieves mention
THEN context includes:
  - 2-3 messages before the mention
  - All messages after the mention
AND context provides full thread understanding
```

### T05.3.4: Include thread replies user participated in
**Code type:** Python script

```pseudo
GIVEN user posted in thread 2 days ago
AND new replies added since last brief
WHEN fetch_slack()
THEN thread included in results
AND marked as "thread_participation"
```

---

## Test Suite: Categorization

### T05.3.5: Categorize DM awaiting reply (high priority)
**Code type:** Python script

```pseudo
GIVEN DM where last message is from another user
WHEN categorize_slack_item(dm)
THEN category = "dm_awaiting_reply"
AND priority = "high"
```

### T05.3.6: Categorize direct mention (high priority)
**Code type:** Python script

```pseudo
GIVEN message containing "@paolo"
AND user has not replied in thread
WHEN categorize_slack_item(mention)
THEN category = "direct_mention"
AND priority = "high"
AND response_needed = true
```

### T05.3.7: Categorize thread participation (medium priority)
**Code type:** Python script

```pseudo
GIVEN thread user participated in
AND new messages but no direct mention
WHEN categorize_slack_item(thread)
THEN category = "thread_participation"
AND priority = "medium"
```

### T05.3.8: Mark thread as replied-to
**Code type:** Python script

```pseudo
GIVEN mention where user already replied after the mention
WHEN categorize_slack_item(mention)
THEN response_needed = false
AND category = "mention_replied"
```

---

## Test Suite: Open Loop Detection

### T05.3.9: Detect commitment in user message
**Code type:** Python script

```pseudo
FOR EACH message in:
  - "I'll review the proposal by EOD"
  - "Will do"
  - "Let me check and get back to you"
  - "I'll send it tomorrow"
WHEN detect_open_loops(message)
THEN commitment_detected = true
AND commitment_text extracted
```

### T05.3.10: Extract deadline from commitment
**Code type:** Python script

```pseudo
GIVEN user message: "I'll have it ready by Friday"
WHEN detect_open_loops(message)
THEN commitment.deadline = "Friday"
```

### T05.3.11: Track open loop for follow-up
**Code type:** Python script

```pseudo
GIVEN user said "I'll review the proposal by EOD" yesterday
AND today is the next day
WHEN generating brief
THEN open_loops section includes:
  "You said 'I'll review the proposal by EOD' in #domain-strategy
   → Did this happen?"
```

---

## Test Suite: People Matching

### T05.3.12: Match Slack username to People file
**Code type:** Python script

```pseudo
GIVEN message from Slack user "@jane"
AND 8_People/jane-smith.md has slack_handle: "@jane" (or name match)
WHEN process_slack_message(message)
THEN person_link = "[[jane-smith]]"
```

### T05.3.13: Match by display name fallback
**Code type:** Python script

```pseudo
GIVEN message from user with displayName: "Jane Smith"
AND 8_People/jane-smith.md has name: "Jane Smith"
WHEN process_slack_message(message)
THEN person_link = "[[jane-smith]]"
```

---

## Test Suite: Output Formatting

### T05.3.14: Format DM for brief
**Code type:** Python script

```pseudo
GIVEN DM:
  - from: @jane
  - text: "Quick question about pricing doc"
  - unreplied
WHEN format_for_brief(dm)
THEN output:
  "- **@jane** asks about pricing doc (unreplied)
   → Suggested action: Quick reply or schedule call"
```

### T05.3.15: Format mention for brief
**Code type:** Python script

```pseudo
GIVEN mention in #domain-strategy:
  - from: @colleague
  - text: "What do you think about the Q1 targets @paolo?"
  - 5 replies, user hasn't responded
WHEN format_for_brief(mention)
THEN output:
  "- **#domain-strategy**: @colleague asking for input on Q1 targets
   Thread has 5 replies, you haven't responded yet
   → [View thread](https://automattic.slack.com/...)"
```

### T05.3.16: Format open loop for brief
**Code type:** Python script

```pseudo
GIVEN open loop from yesterday
WHEN format_open_loop(loop)
THEN output:
  "- You said 'I'll review the proposal by EOD' in #domain-strategy
   → Did this happen?"
```

### T05.3.17: Separate DMs from channel activity
**Code type:** Python script

```pseudo
GIVEN 2 DMs and 3 channel mentions
WHEN format_slack_section()
THEN output structure:
  "**DMs**
   - @jane...
   - @manager...
   
   **Mentions**
   - #domain-strategy...
   - #general..."
```

### T05.3.18: Include thread URL
**Code type:** Python script

```pseudo
GIVEN mention with thread_url
WHEN format_for_brief(mention)
THEN output includes clickable link to thread
```

---

## Test Suite: Interactive Actions

### T05.3.19: Offer to add reply to priorities
**Code type:** Prompt/Response

```pseudo
GIVEN DM awaiting reply presented in brief
WHEN interactive review reaches this item
THEN Claude offers:
  "[r] Add 'Reply to Jane on Slack' to priorities
   [o] Open in Slack
   [s] Skip"
```

### T05.3.20: Confirm open loop completion
**Code type:** Prompt/Response

```pseudo
GIVEN open loop presented: "You said 'I'll review the proposal'"
WHEN interactive review reaches this item
THEN Claude asks:
  "Did you complete this?
   [y] Yes, done
   [c] Carry forward (didn't do it)
   [s] Skip"
```

---

## Test Suite: Filtering

### T05.3.21: Exclude bot messages
**Code type:** Python script

```pseudo
GIVEN messages from Slack bots (automated notifications)
WHEN fetch_slack() processes results
THEN bot messages excluded from results
```

### T05.3.22: Exclude configured channels
**Code type:** Python script

```pseudo
GIVEN config.slack.exclude_channels: ["#random", "#watercooler"]
AND mention in #random
WHEN fetch_slack()
THEN #random mention not included in results
```

### T05.3.23: Handle @channel/@here mentions
**Code type:** Python script

```pseudo
GIVEN config.slack.include_at_channel: false
AND message with @channel but no direct user mention
WHEN fetch_slack()
THEN message not included (unless configured otherwise)
```

---

## Test Suite: Error Handling

### T05.3.24: Handle MCP server unavailable
**Code type:** Python script

```pseudo
GIVEN mock MCP returns connection error
WHEN fetch_slack()
THEN raises MCPUnavailableError
AND error message: "context-a8c MCP not responding"
```

### T05.3.25: Handle MCP timeout
**Code type:** Python script

```pseudo
GIVEN mock MCP times out after 30s
WHEN fetch_slack()
THEN retries once
AND if still fails, raises TimeoutError
```

### T05.3.26: Handle empty results
**Code type:** Python script

```pseudo
GIVEN mock MCP returns 0 messages
WHEN fetch_slack()
THEN returns empty list
AND brief shows: "No Slack updates"
```

---

## Mock Fixtures

### MCP mock responses
```python
MOCK_SLACK_DATA = {
    "mentions": [
        {
            "type": "mention",
            "channel": {"id": "C123", "name": "domain-strategy"},
            "messages": [
                {"user": "U456", "username": "colleague", "text": "What do you think about Q1 targets @paolo?", "ts": "1706778000"},
                {"user": "U789", "username": "manager", "text": "I agree, would love Paolo's take", "ts": "1706778300"}
            ],
            "thread_url": "https://automattic.slack.com/archives/C123/p1706778000",
            "reply_count": 5,
            "user_has_replied": False
        }
    ],
    "dms": [
        {
            "type": "dm",
            "channel": {"id": "D999", "name": "dm-jane"},
            "messages": [
                {"user": "U111", "username": "jane", "text": "Quick question about the pricing doc", "ts": "1706775000"}
            ],
            "thread_url": "https://automattic.slack.com/archives/D999/p1706775000",
            "user_has_replied": False
        }
    ],
    "user_messages": [
        {
            "channel": {"id": "C123", "name": "domain-strategy"},
            "text": "I'll review the proposal and share thoughts by EOD",
            "ts": "1706706000",
            "thread_url": "https://automattic.slack.com/archives/C123/p1706706000"
        }
    ]
}
```
