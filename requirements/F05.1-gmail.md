# F05.1: Morning Brief — Gmail Integration

## Overview

| Attribute | Value |
|-----------|-------|
| Feature ID | F05.1 |
| Parent | F05 (Morning Brief) |
| Priority | Phase 3 (Rituals) |
| Dependencies | F10 (External Sources), F14 (Bootstrap for auth) |

## Purpose

Pull unread and starred emails from Gmail to surface in the morning brief. Identify emails requiring attention and suggest appropriate actions.

---

## Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| F05.1.1 | Pull unread emails since last brief | Must |
| F05.1.2 | Pull starred emails (regardless of read status) | Must |
| F05.1.3 | Access full email body for context | Must |
| F05.1.4 | Exclude configured categories (Promotions, Updates) | Must |
| F05.1.5 | Identify emails requiring response/action | Must |
| F05.1.6 | Link sender to People file if matched | Should |
| F05.1.7 | Suggest actions for each important email | Should |

---

## Access Method

| Setting | Value |
|---------|-------|
| API | Google Workspace API (Gmail) |
| Auth | OAuth 2.0 (configured in bootstrap) |
| Scope | `gmail.readonly` |

---

## Query Parameters

```
Pull emails where:
  - is:unread AND NOT in:promotions AND NOT in:updates
  - OR is:starred
  - AND after:{last_brief_timestamp}
```

### Configuration

From `config.yaml`:

```yaml
sources:
  gmail:
    enabled: true
    exclude_categories:
      - PROMOTIONS
      - UPDATES
```

---

## Data Retrieved

For each matching email:

```json
{
  "id": "msg-123",
  "thread_id": "thread-456",
  "from": {
    "email": "jane@verisign.com",
    "name": "Jane Smith"
  },
  "to": ["paolo@automattic.com"],
  "cc": [],
  "subject": "RE: Bulk Pricing Proposal",
  "snippet": "Leadership approved! Let's schedule...",
  "body": "Full email content here...",
  "date": "2025-01-31T09:15:00Z",
  "labels": ["INBOX", "IMPORTANT"],
  "is_unread": true,
  "is_starred": false,
  "attachments": [
    {
      "filename": "pricing_v2.pdf",
      "mime_type": "application/pdf",
      "size": 245000
    }
  ]
}
```

---

## Processing Logic

### 1. Categorize Emails

| Category | Criteria | Treatment |
|----------|----------|-----------|
| Action Required | Contains request, question, deadline | Highlight in brief |
| FYI | CC'd, newsletter-like, no question | List briefly |
| Starred | User marked important | Always include |

### 2. Identify Action Signals

Scan email body for:
- Questions directed at user ("Can you...", "Would you...")
- Deadlines ("by EOD", "before Friday", specific dates)
- Requests ("Please review", "Need your input")
- Blockers ("Waiting on you", "Can't proceed until")

### 3. Match Sender to People

```
For each email.from.email:
  Search 8_People/ for matching email field
  If found:
    person = matched file
    Include context in brief
  Else:
    person = null
    Optionally offer to create
```

---

## Output Format

### In Daily Note

```markdown
### Emails Requiring Attention

1. **Bulk Pricing Proposal** — [[Jane Smith]] (Verisign)
   Leadership approved the proposal. Requests scheduling a call 
   to discuss next steps.
   → Suggested action: Reply to confirm availability
   
2. **Q1 Metrics Review** — Analytics Team
   Weekly metrics attached. Revenue up 12% MoM.
   → FYI, no action needed
   
3. ⭐ **Contract Draft** — Legal
   Marked starred yesterday. Still unread.
   → Suggested action: Review before EOD
```

### In Terminal (Interactive)

```
EMAILS (3 requiring attention)

1. Bulk Pricing Proposal
   From: Jane Smith (Verisign) — [[jane-smith]]
   Received: 09:15 today
   
   "Leadership approved! Let's schedule a call to discuss 
    implementation timeline. Are you free Thursday?"
   
   This seems to need a reply about availability.
   
   Actions:
     [r] Add "Reply to Jane" to priorities
     [t] Create task: "Schedule call with Jane"
     [s] Skip (will handle manually)
     [v] View full email
   
   Choice: _
```

---

## Action Extraction

When an email clearly contains an actionable item:

```
Email from Legal contains:
  "Please review and sign off on the revised terms by EOD Friday."

Detected action:
  What: Review and sign off on revised terms
  Deadline: Friday EOD (2025-01-31)
  
Create task in Linear?
  [y] Yes → Linear (Totoro)
  [r] Yes → Add to Reminders instead
  [n] No, just note in brief
```

---

## People Integration

When sender matches a People file:

```markdown
1. **Bulk Pricing Proposal** — [[Jane Smith]] (Verisign)
   Last contact: January 28 (discussed bulk discount)
   ...
```

When sender is unknown:

```
Email from sarah@newcompany.com (not in People)

Would you like to create a People file?
  [y] Yes
  [n] No
  [l] Later
```

---

## Failure Handling

| Failure | Behavior |
|---------|----------|
| Auth expired | Skip Gmail, show warning, prompt to re-auth |
| API timeout | Retry once, then skip with warning |
| Rate limited | Use cached data if <4h old |
| No emails | Show "No new emails" in brief |

```
⚠ Gmail: Authentication expired
  Run `claude auth gmail` to reconnect.
  Skipping email section.
```

---

## Privacy Considerations

- Full email bodies are read for context but not stored
- Only summaries appear in daily note
- Sensitive content (passwords, tokens) should not be quoted
- User can configure additional exclusions

---

## Configuration

```yaml
sources:
  gmail:
    enabled: true
    exclude_categories:
      - PROMOTIONS
      - UPDATES
      - SOCIAL        # Optional additional exclusions
    exclude_senders:
      - noreply@*
      - notifications@*
    vip_senders: []   # Future: prioritize these senders
```

---

## Validation

| Check | Expected |
|-------|----------|
| Unread emails retrieved | ✓ |
| Starred emails included | ✓ |
| Excluded categories filtered | ✓ |
| Full body accessible | ✓ |
| People matched when possible | ✓ |
| Actions extracted correctly | ✓ |

---

## Related Features

- **F05 (Morning Brief Core)**: Orchestration
- **F10 (External Sources)**: Gmail configuration
- **F14 (Bootstrap)**: Initial authentication
- **F15 (People)**: Sender matching
