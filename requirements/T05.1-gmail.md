# T05.1: Morning Brief — Gmail Integration — Tests

## Test Environment

```
test-vault-populated/          ← With People files for matching
```

**Mocks:**
- Gmail API responses (predefined email fixtures)
- No network calls

---

## Test Suite: Email Retrieval

### T05.1.1: Fetch unread emails since last brief
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns 5 unread emails
AND last_brief timestamp is 2025-01-30T08:00:00Z
WHEN fetch_gmail(since=last_brief) is executed
THEN returns emails where:
  - is_unread = true
  - date > 2025-01-30T08:00:00Z
```

### T05.1.2: Fetch starred emails regardless of read status
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns:
  - 2 unread emails
  - 1 read but starred email
WHEN fetch_gmail() is executed
THEN returns all 3 emails
AND starred email is included despite being read
```

### T05.1.3: Exclude Promotions category
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns:
  - 2 emails in INBOX
  - 1 email in PROMOTIONS
WHEN fetch_gmail() is executed with config excluding PROMOTIONS
THEN returns only 2 INBOX emails
AND PROMOTIONS email is excluded
```

### T05.1.4: Exclude Updates category
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns:
  - 2 emails in INBOX
  - 1 email in UPDATES (automated notifications)
WHEN fetch_gmail() is executed
THEN UPDATES email is excluded
```

### T05.1.5: Full email body accessible
**Code type:** Python script

```pseudo
GIVEN mock email with body: "Full email content here..."
WHEN fetch_gmail() retrieves email
THEN email.body equals "Full email content here..."
AND body is not truncated
```

---

## Test Suite: Action Detection

### T05.1.6: Detect question requiring response
**Code type:** Python script

```pseudo
GIVEN email with body: "Can you review this proposal by Friday?"
WHEN analyze_email(email) is executed
THEN result.action_required = true
AND result.action_type = "response_needed"
AND result.detected_deadline = "Friday"
```

### T05.1.7: Detect explicit deadline
**Code type:** Python script

```pseudo
FOR EACH (body, expected_deadline) in:
  ("Please respond by EOD", "EOD")
  ("Need this by January 31", "2025-01-31")
  ("ASAP", "ASAP")
  ("before the meeting tomorrow", "tomorrow")
GIVEN email with body: $body
WHEN analyze_email(email)
THEN result.detected_deadline contains $expected_deadline
```

### T05.1.8: Detect blocking language
**Code type:** Python script

```pseudo
GIVEN email with body: "Waiting on your approval to proceed"
WHEN analyze_email(email)
THEN result.action_required = true
AND result.urgency = "high"
AND result.reason contains "blocking"
```

### T05.1.9: Classify FYI emails
**Code type:** Python script

```pseudo
GIVEN email where:
  - user is in CC (not TO)
  - body has no questions
  - no deadlines mentioned
WHEN analyze_email(email)
THEN result.action_required = false
AND result.category = "fyi"
```

---

## Test Suite: People Matching

### T05.1.10: Match sender to People file
**Code type:** Python script

```pseudo
GIVEN email from: jane@verisign.com
AND 8_People/jane-smith.md exists with email: jane@verisign.com
WHEN process_email(email) is executed
THEN result.person_link = "[[jane-smith]]"
AND result.person_context loaded from file
```

### T05.1.11: No match for unknown sender
**Code type:** Python script

```pseudo
GIVEN email from: unknown@example.com
AND no People file has this email
WHEN process_email(email)
THEN result.person_link = null
AND result.offer_create_person = true
```

### T05.1.12: Include last contact info for matched person
**Code type:** Python script

```pseudo
GIVEN email from jane@verisign.com
AND jane-smith.md has last_contact: 2025-01-28
WHEN process_email(email)
THEN result.person_context.last_contact = "2025-01-28"
```

---

## Test Suite: Output Formatting

### T05.1.13: Format email for brief output
**Code type:** Python script

```pseudo
GIVEN processed email:
  - from: Jane Smith <jane@verisign.com>
  - subject: RE: Bulk Pricing Proposal
  - action_required: true
  - person_link: [[jane-smith]]
WHEN format_for_brief(email)
THEN output equals:
  "1. **Bulk Pricing Proposal** — [[Jane Smith]] (Verisign)
   [summary of content]
   → Suggested action: Reply to confirm availability"
```

### T05.1.14: Starred emails marked with indicator
**Code type:** Python script

```pseudo
GIVEN starred email
WHEN format_for_brief(email)
THEN output includes star indicator: "⭐" or similar
```

### T05.1.15: Group emails by priority
**Code type:** Python script

```pseudo
GIVEN 5 emails:
  - 2 action required
  - 1 starred
  - 2 FYI
WHEN format_all_emails(emails)
THEN output sections:
  1. Action Required (2 items)
  2. Starred (1 item)
  3. FYI (2 items, or omitted)
```

---

## Test Suite: Task Extraction

### T05.1.16: Offer to create task from action email
**Code type:** Prompt/Response

```pseudo
GIVEN email with clear action: "Review and sign off by EOD"
WHEN presenting in interactive mode
THEN Claude offers:
  "Create task? [y] Linear (Totoro) / [r] Reminder / [n] No"
```

### T05.1.17: Extract task with deadline
**Code type:** Python script

```pseudo
GIVEN email action: "Review contract by Friday"
AND user confirms task creation
WHEN create_task_from_email(email)
THEN task created with:
  - title: "Review contract"
  - due_date: <Friday's date>
  - source: email reference
```

---

## Test Suite: Error Handling

### T05.1.18: Handle auth expired
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns 401 Unauthorized
WHEN fetch_gmail() is executed
THEN raises AuthExpiredError
AND error message includes "Run `claude auth gmail` to reconnect"
```

### T05.1.19: Handle API timeout
**Code type:** Python script

```pseudo
GIVEN mock Gmail API times out after 10s
WHEN fetch_gmail() is executed
THEN retries once
AND if still fails, raises TimeoutError with helpful message
```

### T05.1.20: Handle rate limiting
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns 429 Too Many Requests
WHEN fetch_gmail() is executed
THEN uses cached data if available and fresh (<4h)
OR reports rate limit error
```

### T05.1.21: Handle empty inbox
**Code type:** Python script

```pseudo
GIVEN mock Gmail API returns 0 emails
WHEN fetch_gmail() is executed
THEN returns empty list
AND does not error
```

---

## Test Suite: Privacy & Security

### T05.1.22: Email bodies not persisted long-term
**Code type:** Python script

```pseudo
GIVEN email fetched and processed
WHEN brief is written to daily note
THEN daily note contains summary, not full email body
AND full body is not stored in any file
```

### T05.1.23: Sensitive content not quoted
**Code type:** Python script

```pseudo
GIVEN email containing patterns like:
  - passwords
  - API keys
  - tokens
  - SSN patterns
WHEN formatting for brief
THEN sensitive content is NOT included in output
AND replaced with "[sensitive content redacted]" or omitted
```

---

## Mock Fixtures

### Gmail API mock responses
```python
MOCK_GMAIL_EMAILS = [
    {
        "id": "msg-001",
        "threadId": "thread-001",
        "from": {"email": "jane@verisign.com", "name": "Jane Smith"},
        "to": ["paolo@automattic.com"],
        "subject": "RE: Bulk Pricing Proposal",
        "snippet": "Leadership approved! Let's schedule...",
        "body": "Hi Paolo,\n\nLeadership approved the proposal. Can you schedule a call to discuss next steps? I'm free Thursday afternoon.\n\nBest,\nJane",
        "date": "2025-01-31T09:15:00Z",
        "labels": ["INBOX", "IMPORTANT"],
        "isUnread": True,
        "isStarred": False
    },
    {
        "id": "msg-002",
        "threadId": "thread-002",
        "from": {"email": "legal@automattic.com", "name": "Legal Team"},
        "to": ["paolo@automattic.com"],
        "subject": "Contract Review Required",
        "body": "Please review and sign off on the revised terms by EOD Friday.",
        "date": "2025-01-31T08:00:00Z",
        "labels": ["INBOX"],
        "isUnread": True,
        "isStarred": True
    },
    {
        "id": "msg-003",
        "threadId": "thread-003",
        "from": {"email": "noreply@service.com", "name": "Automated"},
        "subject": "Your weekly digest",
        "labels": ["PROMOTIONS"],
        "isUnread": True,
        "isStarred": False
    }
]
```

### People fixture for matching
```yaml
# 8_People/jane-smith.md
---
type: person
name: Jane Smith
email: jane@verisign.com
company: Verisign
role: Partner Manager
last_contact: 2025-01-28
---

Context: Primary contact for bulk pricing partnership.
Last discussion: Q1 volume targets and discount structure.
```
