# F05.3: Morning Brief — Slack Integration

## Overview

| Attribute | Value |
|-----------|-------|
| Feature ID | F05.3 |
| Parent | F05 (Morning Brief) |
| Priority | Phase 3 (Rituals) |
| Dependencies | F10 (External Sources) |

## Purpose

Pull Slack messages and mentions to surface important conversations in the morning brief. Identify threads requiring response and provide context for ongoing discussions.

---

## Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| F05.3.1 | Pull messages sent by user since last brief | Must |
| F05.3.2 | Pull messages mentioning user since last brief | Must |
| F05.3.3 | Include surrounding context for mentions | Must |
| F05.3.4 | Identify threads awaiting user response | Must |
| F05.3.5 | Show channel name and thread link | Must |
| F05.3.6 | Match usernames to People files when possible | Should |
| F05.3.7 | Highlight DMs separately from channels | Should |

---

## Access Method

| Setting | Value |
|---------|-------|
| Protocol | MCP (Model Context Protocol) |
| Server | context-a8c |
| Auth | Handled by MCP server |

The context-a8c MCP server provides Slack access for Automattic workspace.

---

## Query Parameters

```
Pull from context-a8c:
  - User's messages since: {last_brief_timestamp}
  - Mentions of user since: {last_brief_timestamp}
  - Include: surrounding context (before/after messages)
  - Include: thread replies if user participated
```

---

## Data Retrieved

```json
{
  "threads": [
    {
      "type": "mention",
      "channel": {
        "id": "C123ABC",
        "name": "domain-strategy"
      },
      "messages": [
        {
          "user_id": "U456DEF",
          "user_name": "colleague",
          "text": "What do you think about the Q1 targets @paolo?",
          "timestamp": "2025-01-31T09:00:00Z",
          "is_mention": true
        },
        {
          "user_id": "U789GHI",
          "user_name": "manager",
          "text": "I agree, would love to hear Paolo's take",
          "timestamp": "2025-01-31T09:05:00Z",
          "is_mention": false
        }
      ],
      "thread_url": "https://automattic.slack.com/archives/C123ABC/p1706778000",
      "reply_count": 5,
      "user_has_replied": false
    },
    {
      "type": "dm",
      "channel": {
        "id": "D999XYZ",
        "name": "dm-jane"
      },
      "messages": [
        {
          "user_id": "U111AAA",
          "user_name": "jane",
          "text": "Quick question about the pricing doc",
          "timestamp": "2025-01-31T08:30:00Z"
        }
      ],
      "thread_url": "https://automattic.slack.com/archives/D999XYZ/p1706775000",
      "user_has_replied": false
    }
  ],
  "user_messages": [
    {
      "channel": {
        "id": "C123ABC",
        "name": "domain-strategy"
      },
      "text": "I'll review the proposal and share thoughts by EOD",
      "timestamp": "2025-01-30T16:00:00Z",
      "thread_url": "https://automattic.slack.com/archives/C123ABC/p1706706000"
    }
  ]
}
```

---

## Processing Logic

### 1. Categorize Threads

| Category | Criteria | Priority |
|----------|----------|----------|
| DM Awaiting Reply | DM where last message isn't from user | High |
| Direct Mention | @user in message | High |
| Thread Participation | User in thread, new replies | Medium |
| User's Open Loops | User said "I'll do X" | Medium |
| FYI | User CC'd or in channel | Low |

### 2. Identify Response Needed

```
For each thread:
  If type == "dm" AND last_message.user != self:
    response_needed = true
  If is_mention AND user_has_replied == false:
    response_needed = true
  If user_message contains commitment ("I'll", "Will do"):
    flag as open_loop
```

### 3. Extract Context

For mentions, include surrounding messages:
- 2-3 messages before the mention
- All messages after until now
- Thread starter if different

### 4. Match Users to People

```
For each message.user_name:
  Search 8_People/ for Slack handle or name match
  If found:
    Link to People file
```

---

## Output Format

### In Daily Note

```markdown
### Slack & P2

**DMs**
- **@jane** asks about pricing doc (unreplied)
  → Suggested action: Quick reply or schedule call

**Mentions**
- **#domain-strategy**: @colleague asking for input on Q1 targets
  Thread has 5 replies, you haven't responded yet
  → [View thread](https://automattic.slack.com/...)

**Your Open Loops**
- You said "I'll review the proposal by EOD" yesterday in #domain-strategy
  → Did this happen?
```

### In Terminal (Interactive)

```
SLACK (3 items need attention)

1. DM from @jane (unreplied)
   "Quick question about the pricing doc"
   Received: 08:30 today
   
   Actions:
     [r] Add "Reply to Jane on Slack" to priorities
     [o] Open in Slack
     [s] Skip
   
   Choice: _

2. Mention in #domain-strategy
   @colleague: "What do you think about the Q1 targets @paolo?"
   Thread: 5 replies, awaiting your input
   
   Actions:
     [r] Add to priorities
     [o] Open in Slack
     [s] Skip
   
   Choice: _

3. Your open loop
   Yesterday you said: "I'll review the proposal by EOD"
   in #domain-strategy
   
   Did you complete this?
     [y] Yes, done
     [c] Carry forward
     [s] Skip
```

---

## Open Loop Detection

When user sends messages containing commitments:

| Pattern | Detection |
|---------|-----------|
| "I'll..." | Commitment detected |
| "Will do" | Commitment detected |
| "Let me..." | Possible commitment |
| "By EOD/tomorrow" | Time-bound commitment |

These are surfaced as open loops in the brief and evening review.

---

## DM Handling

DMs are highlighted separately and given higher priority:

```markdown
**DMs Awaiting Reply**
1. @jane — "Quick question about pricing doc" (2h ago)
2. @manager — "Can we chat about Q1?" (yesterday)
```

DMs older than 24h get extra emphasis.

---

## Channel Noise Filtering

Not every channel message needs attention:

| Include | Exclude |
|---------|---------|
| Direct mentions (@user) | General channel chatter |
| Threads user participated in | Threads user didn't join |
| DMs | Automated bot messages |
| Replies to user's messages | @channel/@here (unless configured) |

---

## Failure Handling

| Failure | Behavior |
|---------|----------|
| MCP unavailable | Skip Slack, show warning |
| MCP timeout | Retry once, then skip |
| Auth issues | Prompt to check MCP config |
| No messages | Show "No Slack updates" |

```
⚠ Slack: context-a8c MCP not responding
  Check MCP server status.
  Skipping Slack section.
```

---

## Configuration

```yaml
sources:
  slack:
    enabled: true
    mcp: context-a8c
    include_channels: all     # or specific channel IDs
    exclude_channels: []      # channels to ignore
    include_at_channel: false # @channel/@here mentions
    dm_priority: high         # DMs always high priority
```

---

## Privacy Considerations

- Message content is read for context but not stored long-term
- Only summaries appear in daily note
- Sensitive channels can be excluded in config
- DM content summarized, not quoted in full

---

## Validation

| Check | Expected |
|-------|----------|
| Mentions retrieved | ✓ |
| DMs retrieved | ✓ |
| Context included | ✓ |
| Open loops detected | ✓ |
| Thread links work | ✓ |
| People matched | ✓ |

---

## Related Features

- **F05 (Morning Brief Core)**: Orchestration
- **F05.4 (P2)**: Similar MCP-based integration
- **F06 (Evening Review)**: Open loop follow-up
- **F10 (External Sources)**: MCP configuration
- **F15 (People)**: User matching
